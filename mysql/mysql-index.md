# Mysql 索引问题

写在前面：

预读一页大概为4k或是4的倍数

1. 索引是mysql中帮助快速获取到数据的数据结构

2. 索引存储在文件中（key+文件+偏移量）

3. 索引存储形势与存储引擎有关（innodb 两个文件）

4. 索引的存储结构：无论树那种树，当层次越深，造成IO操作频繁，影响数据读取的效率

​        总结：如果每个节点有一页（磁盘页），每次操作就需要一次IO，这个深度越深，IO操作就越频繁

1. hash: 不太合适的原因是在数据库查询中我们一般使用范围查询，很少使用等值查询，在hash表中使用的key-value的形式，因此不太合适使用hash来使用查询

2. 二叉树：只有两个分支

3. BST：顺序二叉树

4. AVL：二叉平衡树，高度差不能超过1，通过插入降低性能来换成查询很快

5. 红黑树：是二叉平衡树，读与写差不多时，使用红黑树，要求最长路径不要超过最短路径的两倍既可，任意一条路径上不能包含两个连续的红色节点

6. B树：多叉树，有degree概念，指每个节点最多有degree-1个元素，非叶子节点存储数据，导致我们每个page存储的索引少了叶子节点中的data就是一行一行的记录
7. B+树：在B树的基础上在非叶子节点不存储数据，只存储对应索引值一个节点相当于一次IO操作，mysql在读取的时候是16Kb，mysql中一般在3-4层，存储1000级别数据， B+树不仅从上到下有指针，叶子节点间也有指针，因此B+树有两种对应的查找方式，对主键范围查找与分页查找，另一种是从跟节点查找只有叶子节点间存在指针，非叶子节点间是不存在指针
8. B*树：非叶子节点间也存在指针

# mysql索引

1. innodb中数据与索引是存储在一起的

2. 聚簇索引：当有主键用主键，没有主键使用非空的唯一索引，还是不存在则使用一个用户不可见的自动生成的六个字节的roleid来标示，inodb中如果没有索引，则数据无法存放

3. 非聚簇缩影：

4. my-isam中在叶子中存储的不是data而是指向data的地址

   | innodb         | myisam         |
   | -------------- | -------------- |
   | 支持事物       | 不支持事物     |
   | 表锁与行锁     | 表锁           |
   | 存储数据与索引 | 索引与数据地址 |

5. 默认mysql会自动创建索引，主键或唯一

6. 当我们给普通的数据创建索引，就会形成一个新的b+树，但他的非叶子节点不是存储数据而是存储主键

7. 数据量少时会出现查找慢，是因为走了两次B+树：回表：通过二级索引查询数据，经过两次查找B+树

   ```sql
   select id form table where name='124'//不用经过回表，这种情况称为索引覆盖
   select * from table where name ='123'//需要回表
   ```

8. 最左匹配：如果索引中包含多列，那么会时最最左匹配索引为：（name,age) 不走左边右边不会走

   ```sql
   select id from tab where name=11 and age = 1234
   select id from tab where name=11
   select id from tab where age = 1234 // 只有他不走索引
   select id from tab where age=11 and name = 1234
   ```

9. 索引下推

   1. name,age如果不使用索引下推：先根据name将数据拉去到server层再在server层进行age过滤

   2. name,age如果使用索引下推：根据name与age将数据拉去到server层，再取出相应的数据

10. 谓词下推

    ```sql
    select t.name,t2.name form t join t1 on t.id= t1.id
    //先取出id相同的数据，在取出去除name：如果两个表有300列，那么数据量会比较大
    //将所有拿出来，进行拼接只有两列
    ```

11. 如果索引包含多个列，叫组合索引

12. MRR：mutil-rang-read

    回表：先根据普通索引查询到主键值，根据主键ID取查询需要的正确数据

    根据name查询到的id是没有顺序的，但返回id时，对id进行排序，通过某个范围获取对应的数据

## MVCC（多版本并发控制）

1. mysql事物隔离级别，mysql通过undolog来控制数据读取

| 事务隔离级别          | 脏读 | 不可重复读 | 幻读 |
| --------------------- | ---- | ---------- | ---- |
| 读未提交              | V    | V          | V    |
| 读已提交              |      | V          | V    |
| 可重复读（mysql默认） |      |            | V    |
| 串行化                |      |            |      |

基础储备

1. 磁盘预读：



